---
title: "Lab-05: Data Visualization"
author: Yongpeng Fu
output:
  html_document:
  theme: simplex
  fig_caption: true
---

# Getting started

In this exercise you will use the `ggplot2` package to create visualized summaries of data from the Single Family Loan-Level Data Set, from Freddie Mac.

The Freddie Mac data includes loan-level credit performance data on fixed-rate mortgages. It includes loan-level origination and loan performance and actual loss data on Single Family mortgages acquired by Freddie Mac. The data and more details can be obtained [here](http://www.freddiemac.com/research/datasets/sf_loanlevel_dataset.html). In the User Guide, the section `File Layout & Data Dictionary` contains the description of each variable in the data sets.

For use in this assignment, we have created for you a cleaned data file called `cleaned_Freddie_Mac.Rdata` that combines loan origination and performance data, and saves the results to a data frame called `orig_svcg`. Each observation in the data frame reports monthly performance data for the period Feb 2005 - Sep 2016 for loans that originated between 2005-2007.

Thus, an observation (row) in `orig_svcg` corresponds to a particular loan and month. Variables include

-   `id_loan` - A variable indicating which loan the record corresponds to.
-   `svcg_cycle` - The year and month (YYYYMM) in which the performance record corresponds to.
-   `first_record` - A logical variable that equals `TRUE` for the first record of a loan in the data frame.
-   `st` - The state in which the loan was originated.
-   `fico` - The FICO credit scores of the applicant.
-   `ever_default` - A binary (0/1) variable which equals 1 if a loan is ever in default.

**In all problems below, format your plots to include a title and axis labels.** You can also modify the legend, color and size of the plots and other aspects that make your plot easier to interpret.

Start by loading `tidyverse` package. Also load the Freddie Mac data you downloaded from S3, per the assignment instructions.

```{r, message=FALSE, warning=FALSE}
library(tidyverse)
load("data/cleaned_Freddie_Mac.Rdata")
glimpse(orig_svcg)
```

# Problem 1: Histogram

Using `ggplot`, create a histogram of credit scores. Use a bin width of 5 for the histogram. Use "firebrick" as the bar fill color, and "white" as the bar border color. Set the background color of the plot area to be white, with grey gridlines (hint: here are some `ggplot2` [theme examples](https://www.r-bloggers.com/ggplot2-themes-examples/), with documentation [here](http://ggplot2.tidyverse.org/reference/ggtheme.html).

Remember the data contains monthly mortgage observations (so multiple observations per mortgage). Before making a histogram, use `filter()` and the variable `first_record` to keep only the first record for each mortgage. (After dropping duplicates, you should be left with 3,000 observations.)

Histograms are useful to see the distribution of a unique variable. Notice the range and concentration of credit scores. What does it tell you about individuals that have access to mortgages?

```{r}
orig_svcg %>%
  filter(first_record == TRUE & is.finite(fico)) %>%  
  ggplot(aes(x = fico)) +
  geom_histogram(
    binwidth = 5, 
    fill = "firebrick", 
    color = "white"
  ) +
  labs(
    title = "Distribution of Credit Scores",
    x = "FICO Credit Score",
    y = "Count"
  ) +
  theme_dark()
```

Low FICO individuals don't have access to mortgages.

# Problem 2: Bar graph

Using `ggplot`, create a bar graph showing the fraction of loans in the sample that ever default, by state. As in Problem 1, use only one observation per loan. Use the same color scheme as with the histogram above.

This figure provides information on how default rates vary across different regions of the U.S. Remember these are loans originated between 2005 and 2007.

```{r}
orig_svcg %>%
  filter(first_record == TRUE) %>%
  group_by(st) %>%
  summarise(default_rate = mean(ever_default, na.rm = TRUE),
            n_loans = n(),
            .groups = "drop") %>%
  ggplot(aes(x = reorder(st, default_rate), y = default_rate)) +
  geom_col(fill = "firebrick", color = "white") +
  labs(
    title = "Fraction of Loans Ever in Default by State",
    x = "State",
    y = "Default Rate"
  ) +
  theme_light()
  
```

# Problem 3: Map (advanced and optional)

This problem is advanced, and completely optional. Using `ggplot`, make a "heat" map of default rates across the 48 contiguous U.S. states. In other words, this figure shows the same information as plotted in the Bar Graph of Problem 2, but displayed in map format. (As in Problem 2, use only one observation per loan, and measure default rates based on whether the loan is ever defaults.) If you figure this out, email the Professor and let him know!

```{r}
library(maps)

# 1) Default rate by state (one record per loan)
state_rates <- orig_svcg %>%
  filter(first_record == TRUE) %>%
  group_by(st) %>%
  summarise(default_rate = mean(ever_default, na.rm = TRUE),
            .groups = "drop")

# 2) Map data + state abbreviation â†” full name lookup
states_map <- map_data("state") %>%  # has a "region" column: full state name in lowercase
  as_tibble()

# Build a lookup table from base R vectors: state.abb / state.name
abb2name <- tibble(
  st = state.abb,
  region = tolower(state.name)
)

# 3) Join default rates onto map polygons
map_df <- states_map %>%
  left_join(abb2name, by = "region") %>%
  left_join(state_rates, by = "st") %>% 
  filter(!st %in% c("AK","HI","DC"))   

ggplot(map_df, aes(long, lat, group = group, fill = default_rate)) + # group to prevent clustering neighbor states, fill color with default_rate
  geom_polygon(color = "white", size = 0.2) +
  coord_quickmap() +
  scale_fill_gradient(low = "white", high = "firebrick", name = "Default rate")

```

# Problem 4: Line graph

Plot the default rates by month in a line graph. Note that while Problems 1-3 limited the data to one observation per loan, that restriction should not be applied here. Instead, use the original (monthly) loan observations measure whether the loan is in default in that month.

First, inform R that `svcg_cycle` is a date, using the the `as.Date()` function. The data frame includes only month and year, but for R to interpret it as a date you will also need to provide a day. To format the x-axis, the `scale_x_date()` from `ggplot2` may be useful.

This graph shows how the default rates developed over time. Is this what you expected?

```{r}

orig_svcg = orig_svcg %>%
  mutate(date = as.Date(paste0(svcg_cycle, "01"), format = "%Y%m%d")) #turns into 20050601 for conversion

monthly_default = orig_svcg %>%
  group_by(date) %>%
  summarise(default_rate = mean(default, na.rm = TRUE),
            .groups = "drop")


ggplot(monthly_default, aes(x = date, y = default_rate)) +
  geom_line(color = "firebrick", size = 1) +
  labs(title = "Monthly Default Rates",
       y = "Default Rate") +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  theme_minimal(base_size = 14)
```

# Problem 5: Scatter plot + trendline

Using `ggplot`, create a scatter plot of the default rates by credit score. Use the same sample of observations and measure of "ever default" as in Problem 2.

Also add a linear trendline to the plot. Edit the elements of your plot (e.g. colors, title, labels, etc.) so that it looks like figure below.

```{r}
fico_default <- orig_svcg %>%
  filter(first_record == TRUE, is.finite(fico)) %>% 
  group_by(fico) %>%
  summarise(
    default_rate = mean(ever_default, na.rm = TRUE),
    .groups = "drop"
  )

ggplot(fico_default, aes(x = fico, y = default_rate)) +
  geom_point( color = "firebrick", alpha = 0.6) +  
  geom_smooth(method = "lm", color = "black",se = FALSE,
              linewidth = 1) +     
  labs(
    title = "Default Rate vs Credit Score",
    x = "FICO",
    y = "Default Rate"
  ) +
  theme_minimal(base_size = 14)

```
